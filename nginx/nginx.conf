# Nginx 설정 파일
# 이 파일은 Nginx가 어떻게 요청을 처리할지 정의합니다

# 업스트림 서버 정의
# FastAPI 애플리케이션이 실행되는 서버를 정의합니다
# 'api'는 Docker Compose에서 정의한 FastAPI 서비스 이름입니다
upstream api {
    # FastAPI 서버 주소 (Docker Compose 네트워크 내부)
    server api:8000;
}

# HTTP 서버 블록
server {
    # 포트 80에서 요청을 받습니다 (HTTP 기본 포트)
    listen 80;
    
    # 서버 이름 (도메인 또는 IP)
    server_name localhost;

    # 클라이언트 요청 본문 최대 크기 (파일 업로드 등)
    client_max_body_size 10M;

    # 로그 파일 위치
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # API 요청을 FastAPI로 프록시
    # /api로 시작하는 모든 요청을 FastAPI 서버로 전달합니다
    location /api {
        # 프록시 설정
        proxy_pass http://api;
        
        # 요청 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 헬스 체크 엔드포인트
    location /health {
        proxy_pass http://api/health;
        proxy_set_header Host $host;
    }

    # 루트 경로 (API 문서 또는 기본 페이지)
    location / {
        proxy_pass http://api/;
        proxy_set_header Host $host;
    }

    # 정적 파일 캐싱 (필요한 경우)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

