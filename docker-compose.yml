# Docker Compose 설정 파일
# 여러 컨테이너를 하나의 네트워크에서 함께 실행합니다
# version은 더 이상 필요 없음 (최신 Docker Compose는 자동 감지)

services:
  # PostgreSQL 데이터베이스 서비스
  postgres:
    image: postgres:15-alpine # PostgreSQL 15 버전 (경량 Alpine Linux 기반)
    container_name: dora_postgres
    environment:
      # 데이터베이스 설정 (환경 변수)
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_DB: dora_db
    volumes:
      # 데이터베이스 데이터를 호스트에 영구 저장
      # ./postgres_data는 프로젝트 루트에 생성됩니다
      - ./postgres_data:/var/lib/postgresql/data
    ports:
      # 호스트의 5432 포트를 컨테이너의 5432 포트로 매핑
      # 외부에서 접근 가능 (개발용)
      - "5432:5432"
    healthcheck:
      # 데이터베이스가 준비되었는지 확인
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - dora_network
    restart: always

  # FastAPI 백엔드 서비스
  api:
    build:
      # Dockerfile이 있는 디렉토리
      context: ./backend
      dockerfile: Dockerfile
    container_name: dora_api
    environment:
      # 데이터베이스 연결 정보
      DB_HOST: postgres # Docker Compose 서비스 이름
      DB_PORT: 5432
      DB_USER: admin
      DB_PASSWORD: admin123
      DB_NAME: dora_db
      # JWT 시크릿 키 (프로덕션에서는 반드시 변경!)
      SECRET_KEY: TH-Xej6q7F3K3tJGtR7R20T2miI1h_P0myhfjke-rak
      # Python 경로 설정 (app 모듈을 찾기 위해)
      PYTHONPATH: /app
    volumes:
      # 코드 변경 시 자동 반영 (개발용)
      - ./backend:/app
    ports:
      # 호스트의 8000 포트를 컨테이너의 8000 포트로 매핑
      - "8000:8000"
    depends_on:
      # PostgreSQL이 먼저 시작되도록 설정
      postgres:
        condition: service_healthy
    command: >
      sh -c "
        export PYTHONPATH=/app:$PYTHONPATH &&
        python app/init_db.py &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "
    networks:
      - dora_network
    restart: always

  # Nginx 리버스 프록시 서비스
  nginx:
    image: nginx:alpine # 경량 Nginx 이미지
    container_name: dora_nginx
    ports:
      # 호스트의 8080 포트를 컨테이너의 80 포트로 매핑
      # 웹 브라우저에서 http://localhost:8080로 접근 가능
      - "80:80"
    volumes:
      # Nginx 설정 파일을 컨테이너에 마운트
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Flutter 웹 앱 빌드 결과물 마운트
      # 먼저 'flutter build web --release' 실행 필요
      - ./build/web:/usr/share/nginx/html:ro
    depends_on:
      # API 서비스가 먼저 시작되도록 설정
      - api
    networks:
      - dora_network
    restart: always

# 네트워크 정의
# 모든 서비스가 같은 네트워크에 있어서 서비스 이름으로 통신 가능
networks:
  dora_network:
    driver: bridge
